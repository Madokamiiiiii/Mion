{% extends "base-generic.html" %}

{% block content %}
<h1>{{ challenge.name  }} <a href="https://anilist.co/forum/thread/{{ challenge.thread_id  }}">[Thread]</a>

{% if submission %}
  <a href="https://anilist.co/forum/thread/{{ submission.thread_id }}/comment/{{ submission.comment_id }}">[Comment]</a></h1>
{% else %}
</h1>
{% endif %}

<p>
  {% if error_message %}<p><strong>{{ error_message }}</strong></p>{% endif %}

{% if not response.failed %}
<form method="post">
  {% csrf_token %}
  
  <label for="challenge-start">Challenge Start Date</label>
  <input type="text" name="challenge-start" id="challenge-start" value={{ response.start }}>
  
  <label for="challenge-finish">Challenge Finish Date</label>
  <input type="text" name="challenge-finish" id="challenge-finish" value={{ response.finish }}><br>
  
  <label for="challenge-extra">Challenge Extra</label>
  <textarea class="autoExpand" name="challenge-extra" id="challenge-extra" cols="100">{{ response.extra }}</textarea><br>

  {% if response.prerequisites %}
  <br>
  <hr>
  
  <h3>Challenge Prerequisites</h3>
  
  {% for prerequisite_name, prerequisite_finish_date in response.prerequisites.items %}
  <h4>{{ prerequisite_name }}</h4

  <label for="prerequisite-{{ prerequisite_name }}-finish">Finish Date</label>
  <input type="text" name="prerequisite-{{ prerequisite_name }}-finish" id="prerequisite-{{ prerequisite_name }}-finish" value={{ prerequisite_finish_date }}><br><br>
  {% empty %}
  
  {% endfor %}
  {% endif %}

  <hr>
  
  <p>These requirements are automatically generated from a challenge code. The <a href="https://anilist.co/forum/thread/{{ challenge.thread_id  }}">full challenge post</a> should still be read through for information and reference.</p>
  
  {% for requirement in response.requirements %}
  
  <h3 id="{% if requirement.bonus %}bonus-{% endif %}requirement-{{ requirement.number}}">{% if requirement.bonus %}Bonus{% endif %} Requirement {{ requirement.number }}</h3>
  
  <p>{{ requirement.text }}</p>
  
  {% if requirement.mode != "D" %}
  <label for="mode-{% if requirement.bonus %}bonus-{% endif %}{{ requirement.number }}">Difficulty Mode</label>
  <select name="mode-{% if requirement.bonus %}bonus-{% endif %}{{ requirement.number }}" id="mode-{% if requirement.bonus %}bonus-{% endif %}{{ requirement.number }}">
    <option value="E" {% if requirement.mode == "E" %}selected{% endif %}>Easy</option>
    <option value="N" {% if requirement.mode == "N" %}selected{% endif %}>Normal</option>
    <option value="H" {% if requirement.mode == "H" %}selected{% endif %}>Hard</option>
    <option value="B" {% if requirement.mode == "B" %}selected{% endif %}>Bonus</option>
  </select>
  <br><br>
  {% endif %}
  
  <div class="card">
    <div class="card-body">
      <div class="row no-gutters">
	<div class="col-md">
	  {% if requirement.media %}
	  <h4 class="card-title" name="requirement-title-{% if requirement.bonus %}bonus-{% endif %}{{ requirement.number }}" id="requirement-title-{% if requirement.bonus %}bonus-{% endif %}{{ requirement.number }}"><a href="{{ requirement.link }}" target="_blank" id="requirement-title-{% if requirement.bonus %}bonus-{% endif %}{{ requirement.number }}">{{ requirement.media.title.userPreferred }}</a></h4>

	  <input type="hidden" name="requirement-anime-{% if requirement.bonus %}bonus-{% endif %}{{ requirement.number }}" id="requirement-anime-{% if requirement.bonus %}bonus-{% endif %}{{ requirement.number }}" value="{{ requirement.media.title.userPreferred }}">
	  <input type="hidden" name="requirement-link-{% if requirement.bonus %}bonus-{% endif %}{{ requirement.number }}" id="requirement-link-{% if requirement.bonus %}bonus-{% endif %}{{ requirement.number }}" value="{{ requirement.link }}">
	  {% else %}
	  <h4 class="card-title" name="requirement-title-{% if requirement.bonus %}bonus-{% endif %}{{ requirement.number }}" id="requirement-title-{% if requirement.bonus %}bonus-{% endif %}{{ requirement.number }}"><a href="https://anilist.co/anime/00000" target="_blank" id="requirement-title-{% if requirement.bonus %}bonus-{% endif %}{{ requirement.number }}">Anime Title</a></h4>

	  <input type="hidden" name="requirement-anime-{% if requirement.bonus %}bonus-{% endif %}{{ requirement.number }}" id="requirement-anime-{% if requirement.bonus %}bonus-{% endif %}{{ requirement.number }}" value="Anime Title">
	  <input type="hidden" name="requirement-link-{% if requirement.bonus %}bonus-{% endif %}{{ requirement.number }}" id="requirement-link-{% if requirement.bonus %}bonus-{% endif %}{{ requirement.number }}" value="https://anilist.co/anime/00000">
	  {% endif %}
	</div>
	<div class="col-md text-right">
	  <a class="card-link" href="#anime-search-modal-{% if requirement.bonus %}bonus-{% endif %}{{ requirement.number }}" data-toggle="modal">Change Anime</a>

	  {% if requirement.bonus %}
	  {% include "../partials/search-anime-modal.html" with title_id="requirement-title-bonus-"|add:requirement.number %}
	  {% else %}
	  {% include "../partials/search-anime-modal.html" with title_id="requirement-title-"|add:requirement.number %}
	  {% endif %}
	</div>
      </div>
      <div class="row no-gutters">
	<div class="col-md">
	  <label for="completed-{% if requirement.bonus %}bonus-{% endif %}{{ requirement.number }}">Completed</label>
	  <select name="completed-{% if requirement.bonus %}bonus-{% endif %}{{ requirement.number }}" id="completed-{% if requirement.bonus %}bonus-{% endif %}{{ requirement.number }}">
	    <option value="O" {% if requirement.completed == "O" %}selected{% endif %}>Not Completed</option>
	    <option value="X" {% if requirement.completed == "X" %}selected{% endif %}>Completed</option>
	    {% if challenge.allows_up_to_date %}
	    <option value="U" {% if requirement.completed == "U" %}selected{% endif %}>Up-to-date</option>
	    {% endif %}
	  </select>
	</div>
	<div class="col-md">
	  <label for="requirement-start-{% if requirement.bonus %}bonus-{% endif %}{{ requirement.number }}">Start Date</label>
	  <input type="text" style="width:120px" name="requirement-start-{% if requirement.bonus %}bonus-{% endif %}{{ requirement.number }}" id="requirement-start-{% if requirement.bonus %}bonus-{% endif %}{{ requirement.number }}" value={{ requirement.start }}>
	</div>
	<div class="col-md">
	  <label for="requirement-finish-{% if requirement.bonus %}bonus-{% endif %}{{ requirement.number }}">Finish Date</label>
	  <input type="text" style="width:120px" name="requirement-finish-{% if requirement.bonus %}bonus-{% endif %}{{ requirement.number }}" id="requirement-finish-{% if requirement.bonus %}bonus-{% endif %}{{ requirement.number }}" value={{ requirement.finish }}>
	</div>
      </div>
    </div>
  </div>
  <br>

  <textarea class="autoExpand" name="requirement-extra-{% if requirement.bonus %}bonus-{% endif %}{{ requirement.number }}" id="requirement-extra-{% if requirement.bonus %}bonus-{% endif %}{{ requirement.number }}" cols="100" placeholder="Extra">{{ requirement.extra }}</textarea>
  {% endfor %}
  
  <br><br>
    
  <p>These requirements are automatically generated from a challenge code. The <a href="https://anilist.co/forum/thread/{{ challenge.thread_id  }}">full challenge post</a> should still be read through for information and reference.</p>
  
  <input class="btn btn-primary" type="submit" value="Update Challenge">
</form>
</p>

<p>
  {% if submission.submission_comment_id %}
  <form action="{% url 'awc:delete-submission' submission.comment_id %}" method='GET'>
    <input class="btn btn-primary" type="submit" onclick="return confirm('Are you sure you want to delete your submission?')" value="Delete Submission">
  </form>
  {% else %}
  <form name="submit-post" onsubmit="return checkCompleted()" action="{% url 'awc:submit-post' challenge.name submission.thread_id submission.comment_id %}" method='POST'>
    {% csrf_token %}
    <label for="challenge-difficulty">Challenge Difficulty</label>
    <select name="challenge-difficulty" id="challenge-difficulty">
      <option value="">N/A</option>
      <option value="Easy">Easy</option>
      <option value="Normal">Normal</option>
      <option value="Hard">Hard</option>
    </select>
    
    <input class="btn btn-primary" type="submit" onclick="return confirm('Are you sure you want to submit? Make sure you pressed "Update Challenge" first')" value="Submit">
  </form>
  {% endif %}
</p>

<p id="errors" class="text-danger"></p>
{% else %}
<h2>Error to Report</h2>
<p>
  {{ response.error|linebreaks }}
</p>
<h2>Your Challenge Code</h2>
<p>
  {{ response.comment|linebreaks }}
</p>
{% endif %}

<p>
  <form action="{% url 'awc:delete-post' submission.comment_id %}" method='GET'>
    <input class="btn btn-danger" type="submit" onclick="return confirm('Are you sure you want to delete?')" value="Delete">
  </form>
</p>

{% endblock %}

{% block javascript %}
<script>
  $(document).on("click", '#anime-search-result', function() {
      $('#' + $(this).attr('data-title-target')).find('a').text($(this).attr('data-title'))
      $('#' + $(this).attr('data-title-target')).find('a').attr('href', 'https://anilist.co/anime/' + $(this).attr('data-id'))
      
      if (this.hasAttribute('data-is-bonus')) {
	  $('#requirement-anime-bonus-' + $(this).attr('data-requirement-number')).attr('value', $(this).attr('data-title'))
	  $('#requirement-link-bonus-' + $(this).attr('data-requirement-number')).attr('value', 'https://anilist.co/anime/' + $(this).attr('data-id'))
      } else {
	  $('#requirement-anime-' + $(this).attr('data-requirement-number')).attr('value', $(this).attr('data-title'))
	  $('#requirement-link-' + $(this).attr('data-requirement-number')).attr('value', 'https://anilist.co/anime/' + $(this).attr('data-id'))
      }
      $('.modal').modal('hide');
  });
  
  function checkCompleted() {
      var valid = true;

      document.getElementById('errors').innerHTML = ""

      // Checks for completed status
      var $checkboxes = $('input[id="completed[]"]');
      
      for (const status of $checkboxes) {
	  if (status.checked == false) {
	      document.getElementById('errors').innerHTML = document.getElementById('errors').innerHTML + "<br> Please complete all requirements before submitting...";
	      valid = false;
	  }
      }

      // Checks for start dates
      var $startDates = $('input[id="requirement-start-dates[]"]');

      for (const startDate of $startDates) {
	  if (startDate.value == "DD/MM/YYYY") {
	      document.getElementById('errors').innerHTML = document.getElementById('errors').innerHTML + "<br> Please enter start dates before submitting...";
	      valid = false;
	  }
      }

      // Checks for finish dates
      var $finishDates = $('input[id="requirement-finish-dates[]"]');

      for (const finishDate of $finishDates) {
	  if (finishDate.value == "DD/MM/YYYY") {
	      document.getElementById('errors').innerHTML = document.getElementById('errors').innerHTML + "<br> Please enter finish dates before submitting...";
	      valid = false;
	  }
      }

      // Checks for anime title
      var $animeTitles = $('input[id="anime-titles[]"]');

      for (const animeTitle of $animeTitles) {
	  if (animeTitle.value == "Anime Title") {
	      document.getElementById('errors').innerHTML = document.getElementById('errors').innerHTML + "<br> Please enter anime titles before submitting...";
	      valid = false;
	  }
      }

      // Checks for anime link
      var $animeLinks = $('input[id="anime-links[]"]');

      for (const animeLink of $animeLinks) {
	  if (animeLink.value == "https://anilist.co/anime/00000/") {
	      document.getElementById('errors').innerHTML = document.getElementById('errors').innerHTML + "<br> Please enter anime links before submitting...";
	      valid = false;
	  }
      }

      return valid;
  }
</script>
{% endblock %}
